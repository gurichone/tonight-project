{% extends "teacher/base.html" %}

{% block modorulink %}{{ url_for('teacher.teisyutsu.t_teisyutsu') }}{% endblock %}

{% block content %}
<div>
    <form action="{{ url_for('teacher.teisyutsu.t_teisyutsu_edit', submission_id=submission_id) }}" method="POST">
    {{ form.csrf_token }}
    {{ form.name.label }}{{ form.name }}
    <br>
    {{ form.subject.label }}{{ form.subject }}
    <br>
    {{ form.type.label }}{{ form.type }}
    <br>
    {{ form.rimit.label }}{{ form.rimit }}
    <br>
    {{ form.scoring_type.label }}{{ form.scoring_type }}
    <br>
    {{ form.question.label }}{{ form.question }}
    <br>
    {{ form.testcase.label }}<textarea id="testcase" name="testcase" readonly></textarea>
    <br>
    {{ form.submit }}
    </form>

    <button id="add">追加</button>

    <table id="testcaseTable">
        <tr><th>入力</th><th>出力</th><th></th></tr>
    </table>
</div>

<script>
    let addButton = document.getElementById("add");
    let testcase = document.getElementById("testcase");
    let testcaseTable = document.getElementById("testcaseTable");
    
    function resetClassname() {
        var inputElm = document.getElementsByClassName("input");
        var outputElm = document.getElementsByClassName("output");
        var deleteElm = document.getElementsByClassName("delete");
        inputChange(inputElm, outputElm)
        for (let i = 0; i < deleteElm.length; i++) {
            inputElm[i].addEventListener("change", function(){inputChange(inputElm, outputElm)})
            outputElm[i].addEventListener("change", function(){inputChange(inputElm, outputElm)})
            deleteElm[i].onclick = () => {
                deleteElm[i].parentNode.parentNode.remove();
                inputChange(inputElm, outputElm)
                resetClassname();
            }
        }
    }
    
    
    function addTestcase(input_txt, output_txt) {
        var rowElm = document.createElement("tr");
        rowElm.classList.add("tesacaseRow");
        var data1Elm = document.createElement("td");
        var data2Elm = document.createElement("td");
        var data3Elm = document.createElement("td");
        rowElm.appendChild(data1Elm);
        rowElm.appendChild(data2Elm);
        rowElm.appendChild(data3Elm);
        var newInputElm = document.createElement("textarea");
        var newOutputElm = document.createElement("textarea");
        var newDeleteElm = document.createElement("button");
        newDeleteElm.innerText = "削除";
        newInputElm.innerText = input_txt;
        newOutputElm.innerText = output_txt;
        newInputElm.classList.add("input");
        newOutputElm.classList.add("output");
        newDeleteElm.classList.add("delete");
        data1Elm.appendChild(newInputElm);
        data2Elm.appendChild(newOutputElm);
        data3Elm.appendChild(newDeleteElm);
        testcaseTable.appendChild(rowElm);
    }
    
    function inputChange(inputElm, outputElm){
        var testcaseText = ""
        for (let i = 0; i < inputElm.length; i++){
            if (inputElm[i].value || outputElm[i].value) {
                testcaseText += "\n<<<start>>>\n";
                testcaseText += inputElm[i].value;
                testcaseText += "\n<<<change>>>\n";
                testcaseText += outputElm[i].value;
                testcaseText += "\n<<<end>>>\n"
            }
        }
        testcase.value = testcaseText;
    }
    {% for t in testcase %}
    addTestcase("{{t[0]}}", "{{t[1]}}");
    resetClassname();
    {% endfor %}

    addButton.addEventListener('click', function(){
        addTestcase("", "");
        resetClassname();
    })
</script>
{% endblock %}