{% extends "teacher/base.html" %}
{% block title %}時間割表{% endblock %}
{% block modorulink %}<a href="{{ url_for('teacher.menu.t_menu') }}">戻る</a>{% endblock %}
{% block content %}
    <h1>時間割表</h1>

    <div style="text-align: right; margin: 20px;">
        <a href="{{ url_for('teacher.jikanwari.add_entry') }}">授業を追加</a>
        <a href="{{ url_for('teacher.jikanwari.class_list') }}">授業数一覧</a>
    </div>

    <table>
        <thead>
            <tr>
                <th class="header-cell">
                    <label for="year-filter">年:</label>
                    <select id="year-filter" onchange="updateTable()">
                        <option value="">すべて</option>
                        {% for y in range(2020, 2030) %}
                            <option value="{{ y }}">{{ y }}</option>
                        {% endfor %}
                    </select>
                </th>
                <th class="header-cell">
                    <label for="month-filter">月:</label>
                    <select id="month-filter" onchange="updateTable()">
                        <option value="">すべて</option>
                        {% for m in range(1, 13) %}
                            <option value="{{ m }}">{{ m }}月</option>
                        {% endfor %}
                    </select>
                </th>
                <th class="header-cell">
                    <label for="day-filter">日:</label>
                    <select id="day-filter" onchange="updateTable()">
                        <option value="">すべて</option>
                    </select>
                </th>
                <th class="header-cell">
                    <label for="weekday">曜日:</label>
                    <span id="weekday"></span>
                </th>
                <th>1時間目</th>
                <th>2時間目</th>
                <th>3時間目</th>
                <th>備考</th>
                <th>イベント</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in data %}
            <tr>
                <td>{{ entry.year }}</td>
                <td>{{ entry.month }}月</td>
                <td>{{ entry.day }}日</td>
                <td>{{ entry.weekday }}</td>
                <td>{{ entry.period1 }}</td>
                <td>{{ entry.period2 }}</td>
                <td>{{ entry.period3 }}</td>
                <td>{{ entry.notes }}</td>
                <td>{{ entry.event }}</td>
                <td style="text-align: center;">
                    <a href="{{ url_for('teacher.jikanwari.add_entry') }}">編集</a>
                    <a href="{{ url_for('teacher.jikanwari.add_entry') }}">削除</a> <!-- 削除後、追加画面に遷移 -->
                </td>
                
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/stylecss.css') }}">
    <script>
        // 年、月、日付から曜日を計算する関数
        function getWeekday(year, month, day) {
            const date = new Date(year, month - 1, day); // 月は0から始まるので-1
            const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
            return weekdays[date.getDay()];
        }

        // 年と月を選択したときに日付と曜日を更新する関数
        function updateTable() {
            const year = document.getElementById('year-filter').value;
            const month = document.getElementById('month-filter').value;
            const dayFilter = document.getElementById('day-filter');

            // 日付のプルダウンをリセット
            dayFilter.innerHTML = '<option value="">すべて</option>';

            if (year && month) {
                const daysInMonth = new Date(year, month, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement("option");
                    option.value = day;
                    option.textContent = day + '日';
                    dayFilter.appendChild(option);
                }
            }

            // 選択された日付で曜日を表示
            const selectedDay = document.getElementById('day-filter').value;
            if (selectedDay) {
                const weekday = getWeekday(year, month, selectedDay);
                document.getElementById('weekday').textContent = weekday;
            } else {
                document.getElementById('weekday').textContent = '';
            }

            // データのフィルタリング処理
            filterData(year, month, dayFilter.value);
        }

        // データのフィルタリング
        function filterData(year, month, day) {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowYear = row.cells[0].textContent;
                const rowMonth = row.cells[1].textContent.replace('月', '');
                const rowDay = row.cells[2].textContent.replace('日', '');
                
                // フィルタ条件に一致しない行を非表示に
                if ((year && rowYear !== year) || 
                    (month && rowMonth !== month) || 
                    (day && rowDay !== day)) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });
        }
    </script>
{% endblock %}
